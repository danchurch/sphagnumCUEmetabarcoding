## link to see notebook:

devtools::install_github("thomasp85/patchwork")

https://nbviewer.org/github/danchurch/sphagnumCUEmetabarcoding/blob/main/sequenceAnalysis/firstLookPeat16s.ipynb

## let's take a look at the sequences from Werner. 
## = get an OTU table, check predictors  NMS/permanova etc. 
## if there is anything there, contact florian hartig and get serious with jsdm

## pertinent other scripts (officecomp)
/home/daniel/Documents/projects/mossSymbiosis/nostoc/totalCyanoCommunity/processIllumina16s.txt
/home/daniel/Documents/teaching/funmic/FunctionalMicrobiomePractical/funmic2025/scripts/metabarcoding.txt

## wd
cd /home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis

## raw reads are here:
cd /media/vol/wernerSphagnumSequences/

## let's make symbolic links to these, see if we can avoid doubling storage

cd /home/daniel/Documents/projects/wernerSphagnum/sampleData/sequencingSamples/originalSeqs

destinationDir="/home/daniel/Documents/projects/wernerSphagnum/sampleData/sequencingSamples/originalSeqs/"
originalSeqDir="/media/vol/wernerSphagnumSequences/"
cd ${originalSeqDir}

for i in *; do 
  ln -s ${originalSeqDir}$i ${destinationDir}$i
done

## not sure if we can do everything via links, let's try 

## also perhaps we should back these up somewhere. There is still a bit of room on vol1 on the nanoComp:

#rsync -auv --progress /media/vol/wernerSphagnumSequences test@132.180.112.115:/media/vol1/daniel/wernerPeat

## we had two samples from moss cyanobacterial culture project, don't need these:

cd /home/daniel/Documents/projects/wernerSphagnum/sampleData/sequencingSamples/originalSeqs/
rm Oemik-002018* Oemik-002019*

## how do the qualities look?:
## let's combine them all:

destinationDir=/home/daniel/Documents/projects/wernerSphagnum/sampleData/sequencingSamples/combinedSamps
cat ${destinationDir}* > comboSphagnumRawReads.fastq.gz

fastqc -o . -t 2 comboSphagnumRawReads.fastq.gz 

## looks great, maybe trim off the final 5 bp or so

## where is our sample metadata?
/home/daniel/Documents/projects/wernerSphagnum/sampleData

## let's trim the primers


cd /home/daniel/Documents/projects/wernerSphagnum/sampleData/sequencingSamples/originalSeqs/

outputDir=/home/daniel/Documents/projects/wernerSphagnum/sampleData/sequencingSamples/trimmed_reads
for inputFastq in *; do
    cutadapt --rc \
        -g TCGTGYCAGCMGCCGCGGTAA \
        --length 280 \
        -a GGACTACNVGGGTWTCTAAT \
        -o ${outputDir}${inputFastq} \
           ${inputFastq}
done &> test.log

## go to dada2 


R

library(dada2)
library(phyloseq)
library(Biostrings)
library(ape)
library(ggplot2)
library(RColorBrewer)

## where are our trimmed reads?

wd <- "/home/daniel/Documents/projects/wernerSphagnum/sampleData/sequencingSamples/trimmed_reads"
setwd(wd)

fileNames <- list.files(pattern="fastq.gz")

## do some quality filtering on these reads before denoising

## where should we put these?
filterPath <- "/home/daniel/Documents/projects/wernerSphagnum/sampleData/sequencingSamples/filteredReads"

out <- filterAndTrim(fileNames, filterPath,
              maxN=0, maxEE=2, truncQ=2, rm.phix=TRUE,
              compress=TRUE, multithread=TRUE)

## we lose a lot
sum(out[,2]) / sum(out[,1]) ## ~60% reads retained.

setwd("/home/daniel/Documents/projects/wernerSphagnum/sampleData/sequencingSamples/filteredReads")

err <- learnErrors(fileNames, multithread=TRUE)


save(err, file="../err.rda")

plotErrors(err, nominalQ=TRUE)


## this step defines our ASVs:
dadaF <- dada(fileNames, err=err, pool=TRUE, multithread=TRUE)

save(dadaF, file="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/dadaPeat.rda")

load(file="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/dadaPeat.rda")

## this is taking forever. I think because I only have four cores on this machine.
## Can we repeat it on the optiplex or nanoComp?
## take a break, if it doesn't finish by then port it over. 

## now that we have ASVs, we can make an OTU table:

seqtab <- makeSequenceTable(dadaF)

seqtab

seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)

save(seqtab.nochim, file="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/seqtab.nochimPeat.rda")

load(file="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/seqtab.nochimPeat.rda")

## make row names pretty. Here we need our sample names, etc. 

homedir="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/"
## eco info here

envData <- read.csv(paste0(homedir,"envDataPeat.csv"))
sampleLabels <- read.csv(paste0(homedir,"sampleNames.csv"))
## with this, can we clean up our row names?

## actually, we don't need them:
rownames(seqtab.nochim) <- gsub("trimmed_reads.*_S", "S", rownames(seqtab.nochim)) |> 
gsub("_L.*fastq.gz","",x=_)

path2silvaDB <- "/media/vol/phylo_dbs/silva/silva138.2/silva_nr99_v138.2_toGenus_trainset.fa"

taxa <- assignTaxonomy(seqtab.nochim, path2silvaDB, multithread=TRUE)

ps <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), tax_table(taxa))

dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
## give our ASVs pretty names instead of DNA sequences:
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))

## let's add our "environmental data" (woefully incomplete at this point).
## and our tree, also still really raw: 

homedir="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/"

?read.csv

envData <- read.csv(paste0(homedir,"envDataPeat.csv"), row.names="SampleName")

envData$DepthSection <- as.numeric(envData$DepthSection)

sample_data(ps) = envData


#save(ps, file="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/peat16sPS.rda")

load(file="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/peat16sPS.rda")

sampleLabels <- read.csv(paste0(homedir,"sampleNames.csv"))

str(envData)


## start here to get original PS

load(file="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/peat16sPS.rda")

rank_names(ps)

tax_table(ps)["ASV1",]

tax_table(ps)["ASV4927",]

tax_table(ps)["ASV1",]

tax_table(ps)["ASV17",] 

tax_table(ps)["ASV20",]

tax_table(ps)[1:200,"Genus"]

## our most common bacteria are Ralstonia, the first 20 or so. Seems fishy. 

## plan for today - clean up using negative and positive controls, and get taxonomic overview.

## my little plotting function:

rankAb <- function(phyObj, sampleName, ylimit=500, ntax=NULL, textatX=100, textatY=(ylimit-40)){
    sampleNo0filter <- get_taxa(phyObj, sampleName) > 0
    if(is.null(ntax)) ntax=sum(sampleNo0filter)
    print(sum(sampleNo0filter)) ## let user know how many unique taxa are in sample
    sampleNo0 <- get_taxa(phyObj, sampleName)[sampleNo0filter]
    sampleNo0 <- sort(sampleNo0, decreasing=TRUE)
    sampleNo0 <- sampleNo0[1:ntax]
    taxaNames=tax_table(phyObj)[ names(sampleNo0), "Genus"]
    nuASV <- paste("number of unique ASVs = ",sum(sampleNo0filter), sep="")
    par(cex.axis = .75, mar=c(25,4,4,2))
    barplot(sampleNo0,
        ylim = c(0,ylimit),
        main=sampleName,
        cex.names=1.5,
        las=2,
        names.arg=taxaNames,
           )
    text(textatX, textatY,  nuASV, cex = 2, )
}


## three samples essentially failed:

sample_data(ps)[c("S27","S28","S33")] 
## these are thermokarst:

## S27  AT2_43-63 Thermokarst            1 
## S28  AT2_63-83 Thermokarst            2 
## S33 AT3_80-100 Thermokarst            2 

## lots to check. how do the mock communities, eco rep, and neg controls look?:

dev.off(dev.list())

sample_names(ps)

sample_data(ps)

## our ecological replicate looks pretty good:
rankAb(ps,"S41",ylimit=800, ntax=50)
dev.new()
rankAb(ps,"S8",ylimit=1000, ntax=50)

## our 

rankAb(ps,"S42")

rankAb(ps,"S43",ntaxa=50)

sample="S43"
notZeroFilt <- otu_table(ps)[sample] > 0
abundances <- otu_table(ps)[sample, notZeroFilt]


dev.off(dev.list())

sample="S42"
notZeroFilt <- otu_table(ps)[sample] > 0
otu_table(ps)[sample, notZeroFilt]

rankAb(ps,"S42")

rankAb(ps,"S43",ntax=30)
dev.new()

rankAb(ps,"S44")

rankAb(ps,"S44", ntax=30)

rankAb(ps,"S1", ntax=20)

ps.prop <- transform_sample_counts(ps, function(otu) otu/sum(otu))

filt <- sample_data(ps)$Subsite %in% c("Mock_community_1","Mock_community_2","Negative_PCR")

ps.controls <- prune_samples(filt, ps)

plot_bar(ps.controls, fill = "Phylum") + geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack")


## https://nbviewer.org/github/danchurch/fichtelgebirgeSoils/blob/main/spatialAnalysis/spatialAnalysisSulariData.ipynb

barplot(sort(sample_sums(ps), decreasing=TRUE), cex.names=0.8, las=2)


###### run alignment ######

## let's get the alignment running overnight, another brain-free process we can do for free.

## do it one the nanoComp:

conda create -n ssu-align -c bioconda ssu-align 

setwd("/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/")

rs <- refseq(ps)
writeXStringSet(rs,"wernerSphagnumRefSeqs.fa", format="fasta")


## get this file 

getFile=/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/wernerSphagnumRefSeqs.fa
putFile=/media/vol1/daniel/wernerPeat/
rsync -auv $getFile test@132.180.112.115:$putFile

cd /media/vol1/daniel/wernerPeat/

conda activate ssu-align

nohup ssu-align -n bacteria wernerSphagnumRefSeqs.fa wernerSphagnumRefSeqs_ali &

## to check on this remotely:


## then a strict mask, don't trust any ambiguous calls, because we are forcing the bacterial model on archea
ssu-mask --pf 0.9999 --pt 0.9999 wernerSphagnumRefSeqs_ali

## to get a fasta output of the alignment (what we probably need)
ssu-mask --stk2afa wernerSphagnumRefSeqs_ali

ssuAlignOut="/media/vol1/daniel/wernerPeat/wernerSphagnumRefSeqs_ali/wernerSphagnumRefSeqs_ali.bacteria.afa"
FastTree -gtr -nt < $ssuAlignOut > wernerPeatFastTree.nwk

## get it local:
getFile=/media/vol1/daniel/wernerPeat/wernerSphagnumRefSeqs_ali/wernerPeatFastTree.nwk
putFile=/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/
rsync -auv test@132.180.112.115:$getFile $putFile

## to add this, in R:


archFilter <- as.vector(tax_table(ps)[,"Kingdom"] == "Archaea")
archFilter[is.na(archFilter)] <- FALSE
archaeaPS = prune_taxa(archFilter, ps)

aa = ape::read.tree("wernerPeatFastTree.nwk")

taxa_names(archaeaPS)

rooted_tree = root(aa, outgroup = taxa_names(archaeaPS), resolve.root = TRUE)

## these didn't make it into the tree:
taxa_names(archaeaPS)[!(taxa_names(archaeaPS) %in% aa$tip.label)]

## "ASV4652" "ASV4698" "ASV4701" "ASV5339"

notInTree=c("ASV4652","ASV4698","ASV4701","ASV5339")

tax_table(ps)[notInTree] ## Halobacteriota, Nanoarcheota

notInTreeAbund <- otu_table(ps)[,notInTree]
notInTreeAbund[rowSums(notInTreeAbund) > 0,]

## these are pretty low abundances, in not many samples
## ASV4652 ASV4701 (halobacterota) are present only in the moss negative
## control. ASV4698 and ASV5339 (nanoarchaeota)

## in general, the sequences that didn't align are in this file:
getFile=/media/vol1/daniel/wernerPeat/wernerSphagnumRefSeqs_ali/wernerSphagnumRefSeqs_ali.nomatch
putHere=/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/
rsync -auv test@132.180.112.115:$getFile $putHere

## not sure how this will affect our pipeline. March on and find out.
## for the moment, remove these four archaea ASVs that didn't align from
## our analysis:

notInTree = c("ASV4652","ASV4698","ASV4701","ASV5339")
inTree = !(rownames(tax_table(ps)) %in% notInTree)
ps.inTree <- prune_taxa(inTree, ps)

## and repeat:
aa = ape::read.tree("wernerPeatFastTree.nwk")
archFilter <- as.vector(tax_table(ps.inTree)[,"Kingdom"] == "Archaea")
archFilter[is.na(archFilter)] <- FALSE
archaeaPS = prune_taxa(archFilter, ps.inTree)
rooted_tree = root(aa, outgroup = taxa_names(archaeaPS), resolve.root = TRUE)
phy_tree(ps.inTree) <- rooted_tree
plot_tree(ps.inTree, color="Kingdom")

#save(ps.inTree, file="ps_inTree.rda")

## start here to get the ps pruned to the tree

library(phyloseq)
library(ggplot2)

load("peat16sPS.rda")
load("ps_inTree.rda")

## looks great. Now let's examine our positive controls and try 
## to get an idea of proper otu clustering.

sort(get_taxa(ps, "S42"))

rankAb(ps,"S42")

rankAb(ps,"S43",ntax=30)


## get a list of abundances our target taxa from the positive controls:
getMCgenera <- function(sampleName, phyObj){
  sampleNo0filter <- get_taxa(phyObj, sampleName) > 0
  sampleNo0 <- get_taxa(phyObj, sampleName)[sampleNo0filter]
  sampleNo0 <- sort(sampleNo0, decreasing=TRUE)
  taxaNames=tax_table(phyObj)[ names(sampleNo0), "Genus"]
  names(sampleNo0) <- taxaNames
  mcShould <- c("Bacillus", "Chryseobacterium", "Clostridium", "Enterobacter", "Klebsiella", "Franconibacter", "Glycomyces", "Pseudomonas", "Rhizobium ", "Rhizobium", "Streptomyces", "Variovorax")
  possibleMCasvs <- rownames(taxaNames[taxaNames %in% mcShould])
  onlyMCasvs <- prune_taxa(possibleMCasvs, phyObj)
  realMCs <- get_taxa(onlyMCasvs, sampleName)
  genera <- realMCs
  names(genera) <- taxaNames[names(realMCs)]
  return(list(onlyMCasvs, realMCs, genera))
}


S43mcGenera <- getMCgenera("S43", ps.inTree)[[3]]

S42mcGenera <- getMCgenera("S42", ps.inTree)[[3]]

## did rhizobium get matched to some weird complex name like last time?:
names(S43mcGenera)[grep("obium",names(S43mcGenera))] ## no. mostly just "Rhizobium"

names(S42mcGenera)[grep("obium",names(S42mcGenera))] ## no. mostly just "Rhizobium"

## just checking, an alternate name for Variovorax is:
grep("Alcaligenes", names(S43mcGenera)) ## nope

## these "should" be in our MCs:
mcShould <- c("Bacillus", "Chryseobacterium", "Clostridium", "Enterobacter", "Klebsiella", "Franconibacter", "Glycomyces", "Pseudomonas", "Rhizobium", "Rhizobium", "Streptomyces", "Variovorax", "Escherichia-Shigella")

unique(names(S42mcGenera)[names(S42mcGenera) %in% mcShould]) 
mcShould[!(mcShould %in% names(S42mcGenera))] ## in MC/P42, missing Rhizobium and Variovorax

unique(names(S43mcGenera)[names(S43mcGenera) %in% mcShould]) 

mcShould %in% names(S43mcGenera) ## in MC/P43, all there
mcShould[!(mcShould %in% names(S43mcGenera))]

## variovorax is extremely rare in MC1/S43, just one read in the controls:
aa <- subset_taxa(ps, Genus=="Variovorax") |> subset_samples(physeq=_, Subsite %in% c("Mock_community_1","Mock_community_2"))

## great. So that member of our positive controls was essentially lost. 



## so, what level of clustering do we need to get to 
## get rid of most of this splitting?

## for the moment, let's focus on MC2/P43, this has more 
## information in it

phyObj <- ps.inTree
sampleName <- "S43"
mcASVs <- names(getMCgenera(sampleName, ps.inTree)[[2]])
psControls = prune_samples(sampleName, phyObj)
psControls = prune_taxa(mcASVs, psControls)
plot_tree(psControls, color="Genus", label.tips="Genus", ladderize="left", text.size=3)

plot_tree(psControls, color="Genus", label.tips="Genus", ladderize="left", text.size=3) + 
theme( legend.text = element_text(size=20)) #change legend text font size

plot_tree(psControls, color="Genus", label.tips="Genus", ladderize="left", text.size=3) + 
theme(legend.key.size = unit(1, 'cm'), #change legend key size
        legend.title = element_text(size=14), #change legend title font size
        legend.text = element_text(size=10)) #change legend text font size

## pretty. Now try some tip agglomerations, at different cophenetic distances:

checkH <- function(phyObj, sampleName, distance){
    tippedDownPS <- tip_glom(phyObj, h=distance)
    sampleNo0filter <- get_taxa(tippedDownPS, sampleName) > 0
    sampleNo0 <- get_taxa(tippedDownPS, sampleName)[sampleNo0filter]
    sampleNo0 <- sort(sampleNo0, decreasing=TRUE)
    taxaNames=tax_table(tippedDownPS)[ names(sampleNo0), "Genus"]
    names(sampleNo0) <- taxaNames
    mcShould <- c("Bacillus", "Chryseobacterium", "Clostridium", "Enterobacter", "Klebsiella", "Franconibacter", "Glycomyces", "Pseudomonas", "Rhizobium ", "Rhizobium", "Streptomyces", "Variovorax")
    possibleMCasvs <- rownames(taxaNames[taxaNames %in% mcShould])
    psControls = prune_samples(sampleName, tippedDownPS)
    psControls = prune_taxa(possibleMCasvs, psControls)
    #dev.new()
    #plot_tree(phyObj, title=distance, color="Genus", label.tips="Genus", ladderize="left", text.size=3)
    #dev.new()
    #rankAb(tippedDownPS, sampleName, ylimit=10000) 
    return(tippedDownPS)
}

## plot original
dev.new()
plot_tree(psControls, title="unGlommed", color="Genus", label.tips="Genus", ladderize="left", text.size=3)

phyObj <- ps.inTree
sampleName <- "S43"
#distance <- "0.005"
distance <- "0.007"
#distance <- "0.008"
#distance <- "0.01"
#distance <- "0.02"
#distance <- "0.03"
#ps005 <- checkH(phyObj, sampleName, distance)
ps007 <- checkH(phyObj, sampleName, distance)
#ps008 <- checkH(phyObj, sampleName, distance)
#ps01 <- checkH(phyObj, sampleName, distance)
#ps02 <- checkH(phyObj, sampleName, distance)
#ps03 <- checkH(phyObj, sampleName, distance)

#ps05 <- tip_glom(ps.inTree, h=0.05)
#ps03 <- tip_glom(ps.inTree, h=0.03)
#ps01 <- tip_glom(ps.inTree, h=0.01)
#ps008 <- tip_glom(ps.inTree, h=0.008)
#ps007 <- tip_glom(ps.inTree, h=0.007)
ps003 <- tip_glom(ps.inTree, h=0.003)

dev.off()

#phyObj <- ps05 ## just four otus, but no splitting. Two pseudomonas OTUs.
#phyName <- deparse(substitute(ps05))

#phyObj <- ps03 ## Still only four OTUs but already splitting Pseudomonas into 4, Clostridium into 3
#phyName <- deparse(substitute(ps03))

#phyObj <- ps01 ## We recover a 9 OTUs, (2 hidden in Pseudomonas), still missing streptomyces, enterobacter
#phyName <- deparse(substitute(ps01))

#phyObj <- ps008 ## 10 OTUs, still missing enterobacter
#phyName <- deparse(substitute(ps008))
#rankAb(ps008, "S43", ylimit=1000, ntax=30)
#ps.008.genus <- tax_glom(ps008, taxrank="Genus")
#rankAb(ps.008.genus, "S43", ylimit=5000, ntax=30) nope, completely lost.

phyObj <- ps007 ## still missing enterobacter! And so much splitting...
phyName <- deparse(substitute(ps007))

## if we melt by genus:
#ps.007.genus <- tax_glom(ps007, taxrank="Genus")

rankAb(ps007, "S43", ylimit=1000, ntax=30)
rankAb(ps.007.genus, "S43", ylimit=5000, ntax=30)
## still not there. 


dev.new()
sampleName <- "S43"
mcASVs <- names(getMCgenera(sampleName, phyObj)[[2]])
psControls = prune_samples(sampleName, phyObj)
psControls = prune_taxa(mcASVs, psControls)
plot_tree(psControls, color="Genus", label.tips="Genus", ladderize="left", text.size=4) +  
theme( legend.text = element_text(size=20))  +
ggtitle(phyName)

## in each case, get back down to just control sample and 
## non-contaminate ASVs
mcASVs <- names(getMCgenera(sampleName, ps.inTree)[[2]])
psControls = prune_samples(sampleName, phyObj)
psControls = prune_taxa(mcASVs, psControls)
psControlsGlommed = prune_samples(sampleName, ps007)
psControlsGlommed = prune_taxa(mcASVs, psControlsGlommed)

psControlsGlommed

dev.new()
plot_tree(psControlsGlommed, title=distance, color="Genus", label.tips="Genus", ladderize="left", text.size=3)
    
## at h=0.02 we still have too many pseudomonas, clostridium, but we start to lose some other species
## 0.005 has a lot of splitting, still, but keeps all the genera. 
## 0.008 we lose variovox
## h = 0.007 seems fine. Still a lot of splitting, but less than the unglommed data,
## and we retain at least a clade (tip) for each OTU, even though Enterobacter gets
## lumped into an unnamed genus. 
## Let's use this going forward.

## we can also use our positive and negative controls to clean things up a bit.
## for simplicity, since there is always a risk of index-bleed, let's
## subtract the maximum abundances in each OTU present in our controls from our
## ecological samples (excluding our ecological replicate, S41). 

## how do we do this?:

## a ps object of just our controls:

#ps007 <- tip_glom(ps.inTree, h=0.007)
load("ps007.rda")

controlsNotEcoRep <- c("Mock_community_1","Mock_community_2","Negative_PCR","Moss_Negative_PCR")
ps007.controls <- subset_samples(physeq=ps007, Subsite %in% controlsNotEcoRep)

ps007.controls

## for every OTU observed in the controls, 
## subtract the maximum number of reads observed in the 
##  

aa <- otu_table(ps007.controls)
bb <- otu_table(ps007)
controlAbus <- apply(aa, 2, max)
cc <- bb - controlAbus
## because we are only allowed to subtract columns...
cc <- t(t(bb) - controlAbus)

## do some sanity checks:
asv = "ASV4847"
controlAbus[asv]
aa[,asv]
cbind(bb[,asv], cc[,asv])

## get rid of negatives
cc[cc < 0 ] <- 0

## but we want to keep our original controls?

## now plug that back in:
ps007_cleaned <- ps007
otu_table(ps007_cleaned) <- cc


## check it, should have zeroed out the controls:
controlsNotEcoRep <- c("Mock_community_1","Mock_community_2","Negative_PCR","Moss_Negative_PCR")
ps007.cleaned.controls <- subset_samples(ps007_cleaned, Subsite %in% controlsNotEcoRep)
sum(otu_table(ps007.cleaned.controls)) ## yup

#save(ps007_cleaned, file="ps007_cleaned.rda")
load("ps007_cleaned.rda")
load("ps007.rda")

## further cleaning steps?


## 0 - transformations
## 1 - taxonomic overview

## 2 - ordinations by the data we have

##### transformations #####

## coming back to this in feb 2026...
## looking at our mock community controls,
## after melting the tips to .007:

barplot(sort(sample_sums(ps), decreasing=TRUE), 
        ylab="number of reads",
        xlab="Sample number",
        cex.names=1.2, 
        las=2)


barplot(sort(sample_sums(ps007), decreasing=TRUE), 
        ylab="number of reads",
        xlab="Sample number",
        cex.names=1.2, 
        las=2)

rankAb(ps007,"S42",ylimit=2000, ntax = 30)

dev.new()

rankAb(ps007,"S42",ylimit=1500, ntax = 30)


plot_tree(psControls, title="unGlommed", color="Genus", label.tips="Genus", ladderize="left", text.size=3)

## the differential abundances are hard to estimate, given the splitting. 
## if we merge the genera:

rank_names(ps)

ps007

load("ps_inTree.rda")

ps.inTree.genus <- tax_glom(ps.inTree, taxrank="Genus")

ps.007.genus <- tax_glom(ps007, taxrank="Genus")

rankAb(ps.inTree.genus,"S42",ylimit=5000, ntax = 30)

rankAb(ps.inTree.genus,"S42",ylimit=5000, ntax = 30)

rankAb(ps.007.genus,"S43",ylimit=5000, ntax = 30)

## this looks much better. Is there any reason not to do the analysis at this level?
## we would lose precision in picrust, I think. 
## so use the genera level glomming for graphics etc,
## but conduct the picrust with the unglommed data

dev.off()

rankAb(ps007,"S42",ylimit=1500, ntax = 30)

dev.new()

rankAb(ps.007.genus,"S42",ylimit=5000, ntax = 30)

dev.new()
rankAb(ps.007.genus,"S43",ylimit=5000, ntax = 30)

## in the data that is glommed to genus level, we see a range of 
## ~500 to ~4000. So one order of magnitude difference in what
## should be ~same abundances, in terms of DNA concentration. 
## so let's add a log transformation, then do relative 
## abundances. 

?transform_sample_counts

ps007_cleaned_log <- transform_sample_counts(ps007_cleaned, log)
ps007_cleaned_sqrt <- transform_sample_counts(ps007_cleaned, sqrt)

ps007_sqrt <- transform_sample_counts(ps007, sqrt)

ps.007.genus.sqrt <- transform_sample_counts(ps.007.genus, sqrt)

## sqrt seems like a nice solution 
## after this convert to relative abundance
## so the pipeline from raw reads to ecological community matrix abundances is:

## glom tips to c=.007 
## remove all OTUs present in our controls, to the maximum amount present in the controls
## take square root of remaining abundances
## convert to relative abundances:
## so start over from here:

R 

library("phyloseq")
library("patchwork")
library("ggplot2")

load("ps_inTree.rda")

ps007 <- tip_glom(ps.inTree, h=0.007)

controlsNotEcoRep <- c("Mock_community_1","Mock_community_2","Negative_PCR","Moss_Negative_PCR")
ps007.controls <- subset_samples(physeq=ps007, Subsite %in% controlsNotEcoRep)
aa <- otu_table(ps007.controls)
bb <- otu_table(ps007)
controlAbus <- apply(aa, 2, max)
cc <- t(t(bb) - controlAbus) ## this is how you subtract a row from a matrix in R
cc[cc < 0 ] <- 0
ps007_cleaned <- ps007
otu_table(ps007_cleaned) <- cc
## get rid of controls and ecological duplicate:
ps007_cleaned <- subset_samples(ps007_cleaned, EcoCont != "Control") 
## and get rid of the low abundance samples:
ps007_cleaned <- prune_samples(sample_sums(ps007_cleaned)>=1000, ps007_cleaned)



## then the transformations:

ps007_sqrt <- transform_sample_counts(ps007, sqrt)

ps007_sqrt_genus <- tax_glom(ps007_sqrt, taxrank="Genus")

dev.off()

rankAb(ps007, "S43", ylimit=2000, ntax=30)
dev.new()
rankAb(ps007_sqrt, "S43", ylimit=100, ntax=30)
dev.new()
rankAb(ps007_sqrt_genus, "S43", ylimit=1000, ntax=30)


ps007_cleaned_sqrt <- transform_sample_counts(ps007_cleaned, sqrt)

ps007_cleaned_sqrt_prop <- transform_sample_counts(ps007_cleaned_sqrt, function(otu) otu/sum(otu))
#save(ps007_cleaned_sqrt_prop, file="ps007_cleaned_sqrt_prop.rda")

par(mfrow = c(1,2))
rankAb(ps007_sqrt, "S43", ylimit=100, ntax=30)
rankAb(ps007_sqrt, "S43", ylimit=100, ntax=30)

## let's update the notebook with this:

dev.off()

rankAb(ps.007.genus,"S42",ylimit=2000, ntax = 30)
dev.new()

## just checking negative controls:

dev.new()
rankAb(ps007,"S44",ylimit=1500, ntax = 30)
dev.new()
rankAb(ps007,"S47",ylimit=1500, ntax = 30)

## funny, S47  is supposedly dominated by Enhydrobacter, a rare microbe, anaerobic
## which otu is that?

## four OTUs, ASV1255 ASV2041 ASV1036 ASV1155
## they are most abundant in the moss negative control.


aa <- subset_taxa(ps007, Genus == "Enhydrobacter")
head(as.data.frame(refseq(aa)))

## blasting these, yeah the closest match is a skin-associated 
## bacteria identified as in an automated pipeline as Enhydrobacter 
## so yeah, contaminant. 

## okay, that lends more credence to the method of just subtracting
## out all abundances from our controls.  


rankAb(ps.007.genus.sqrt,"S42",ylimit=100, ntax = 30)

dev.new()
rankAb(ps007_cleaned_log,"S10",ylimit=10, ntax = 30)

ps.prop <- transform_sample_counts(ps007, function(otu) otu/sum(otu))

dev.off()


sampleName="S42"
aa <- prune_samples(sampleName, ps007_cleaned)

rankAb(aa, sampleName, ylimit=5000, ntax = 30)

rankAb(ps007,"S43",ylimit=2000, ntax = 30)
dev.new()
rankAb(aa,"S43",ylimit=5000, ntax = 30)


## student needs some data:
aa <- as.data.frame(as.matrix(sample_data(ps007_cleaned_sqrt_prop)))
write.csv(aa, file="example_environmentalMatrix.csv")

write.csv(otu_table(ps007_cleaned_sqrt_prop), file="example_communityMatrix.csv")

load("ps007_cleaned_sqrt_prop.rda")

## think she also needs the reference sequences.

aa <- as.data.frame(as.matrix(sample_data(ps007_cleaned_sqrt_prop)))

rs <- refseq(ps007_cleaned_sqrt_prop)

writeXStringSet(rs,"reference16Ssequences_exampleCommunity.fa", format="fasta")

dim(otu_table(ps007_cleaned_sqrt_prop))


plot_bar(ps007_cleaned_sqrt_prop, fill = "Kingdom") +
  geom_bar(aes(color=Kingdom, fill=Kingdom), stat="identity", position="stack") +
  theme(axis.text=element_text(size=12))

sample_data(ps007_cleaned_sqrt_prop)

## if we want to split our plots by thermokarst/Palsa:

phylumPalTherm <- plot_bar(ps007_cleaned_sqrt_prop, fill = "Kingdom", facet_grid=~Subsite) +
                    geom_bar(aes(color=Kingdom, fill=Kingdom), stat="identity", position="stack") +
                    theme(axis.text=element_text(size=12))

phylumPalTherm

## pretty obvious that the archea are mostly in the water. 

## maybe better split up the phyloseq object:

library("phyloseq")
library("patchwork")
library("ggplot2")
load("ps007_cleaned_sqrt_prop.rda")

ps.justPalsa <- subset_samples(ps007_cleaned_sqrt_prop, Subsite=="Palsa")
ps.justThermokarst <- subset_samples(ps007_cleaned_sqrt_prop, Subsite=="Thermokarst")

phylumPal <- plot_bar(ps.justPalsa, fill = "Kingdom") +
               geom_bar(aes(color=Kingdom, fill=Kingdom), stat="identity", position="stack") +
               theme(axis.text=element_text(size=12))


phylumThermokarst <- plot_bar(ps.justThermokarst, fill = "Kingdom") +
               geom_bar(aes(color=Kingdom, fill=Kingdom), stat="identity", position="stack") +
               theme(axis.text=element_text(size=12))

## works^^, but this is better vv ##

phylumPal <- plot_bar(ps.justPalsa, x="DepthSection", fill = "Kingdom", facet_grid=~Core ) +
               geom_bar(aes(color=Kingdom, fill=Kingdom), stat="identity", position="stack") +
               theme(axis.text=element_text(size=12))

phylumPal


phylumThermokarst <- plot_bar(ps.justThermokarst, x="DepthSection", fill = "Kingdom", facet_grid=~Core) +
               geom_bar(aes(color=Kingdom, fill=Kingdom), stat="identity", position="stack") +
               theme(axis.text=element_text(size=12))

dev.new()

phylumThermokarst

splitGraphicPhyla <- phylumPal + phylumThermokarst ## almost works...

ggsave("splitGraphicPhyla.svg", 
        device = svg,
        plot = splitGraphicPhyla, 
        width = 10, 
        height = 6)

## but that is too huge and isn't available for editing in inkscape.
## try reducing melting all OTUs with a phyla to one OTU:


ps.justPalsa <- subset_samples(ps007_cleaned_sqrt_prop, Subsite=="Palsa")
ps.justPalsa.Kingdom <- tax_glom(ps.justPalsa, taxrank="Kingdom")
ps.justThermokarst <- subset_samples(ps007_cleaned_sqrt_prop, Subsite=="Thermokarst")
ps.justThermokarst.Kingdom <- tax_glom(ps.justThermokarst, taxrank="Kingdom")

kingdomPal <- plot_bar(ps.justPalsa.Kingdom, x="DepthSection", fill = "Kingdom", facet_grid=~Core ) +
               geom_bar(aes(color=Kingdom, fill=Kingdom), stat="identity", position="stack") +
               theme(axis.text=element_text(size=12)) +
               theme(legend.position="none") +
               labs(title='Palsa') + theme(plot.title = element_text(hjust = 0.5))
kingdomThermokarst <- plot_bar(ps.justThermokarst.Kingdom, x="DepthSection", fill = "Kingdom", facet_grid=~Core) +
               geom_bar(aes(color=Kingdom, fill=Kingdom), stat="identity", position="stack") +
               theme(axis.text=element_text(size=12)) +
               theme( axis.text.y=element_blank(),
                      axis.ticks.y=element_blank() ) +
               ylab(NULL) +
               labs(title='Thermokarst') + theme(plot.title = element_text(hjust = 0.5))

splitGraphicKingdom <- kingdomPal + kingdomThermokarst 
splitGraphicKingdom

ggsave("splitGraphicKingdom.svg", 
        device = svg,
        plot = splitGraphicKingdom, 
        width = 10, 
        height = 6)

getFile="/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/splitGraphicPhyla.svg"
putHere="/home/daniel/Documents/projects/wernerSphagnum/graphics/"
rsync -auv $getFile daniel@132.180.113.114:$putHere


## S10 has a surprising amount of archea, what is it?

sample_data(ps007_cleaned_sqrt_prop)["S10",]
## deep, depth section 5

## and surprisingly few in this thermokarst:
sample_data(ps007_cleaned_sqrt_prop)["S21",] ## depth zero

## would be good to order and label by depth 

## we can save this out:
#ggsave("raw_phylumPalTherm.svg", 
        device = svg,
        plot = phylumPalTherm, 
        width = 10, 
        height = 6)

## let's also get a nice, (sub?)phylum level graphic 
## also need a breakdown of archea, after this:


## top taxa, shared by palsa and tk:
psObject <- ps007_cleaned_sqrt_prop_phyla
howManyPhyla <- 10

## get overall (Bact and Arch) ps object
psObject_phyla <- tax_glom(psObject, taxrank="Phylum")
topSharedPhyla <- names(sort(colSums(otu_table(psObject_phyla)), decreasing=TRUE)[1:howManyPhyla])
psObject_topSharedPhyla <- prune_taxa(topSharedPhyla, psObject_phyla)
psObject_topSharedPhyla.palsa <- subset_samples(psObject_topSharedPhyla, Subsite=="Palsa")
psObject_topSharedPhyla.thermokarst <- subset_samples(psObject_topSharedPhyla, Subsite=="Thermokarst")
phylumTopShared.Pal <- plot_bar(psObject_topSharedPhyla.palsa, x="DepthSection", fill = "Phylum", facet_grid=~Core ) +
                       geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack") +
                       theme(axis.text=element_text(size=12)) +
                       theme(legend.position="none") +
                       labs(title='Palsa') + theme(plot.title = element_text(hjust = 0.5))
phylumTopShared.tk  <- plot_bar(psObject_topSharedPhyla.thermokarst, x="DepthSection", fill = "Phylum", facet_grid=~Core ) +
                       geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack") +
                       theme(axis.text=element_text(size=12)) +
                       theme( axis.text.y=element_blank(),
                              axis.ticks.y=element_blank() ) +
                       ylab(NULL) +
                       labs(title='Thermokarst') + theme(plot.title = element_text(hjust = 0.5))

dev.off()

dev.new()

phylumTopShared.Pal + phylumTopShared.tk

#psObject <- ps007_cleaned_sqrt_prop_phyla
psObject <- ps007_cleaned_sqrt_prop
howManyPhyla <- 10
## and if we allow the top phyla to vary between pal and tk sites?
ps.justPalsa <- subset_samples(psObject, Subsite=="Palsa")
ps.justPalsa.Phyla <- tax_glom(ps.justPalsa, taxrank="Phylum")
ps.justThermokarst <- subset_samples(psObject, Subsite=="Thermokarst")
ps.justThermokarst.Phyla <- tax_glom(ps.justThermokarst, taxrank="Phylum")
topPhyla_palsa <- names(sort(colSums(otu_table(ps.justPalsa.Phyla)), decreasing=TRUE)[1:howManyPhyla])
topPhyla_Thermokarst <- names(sort(colSums(otu_table(ps.justThermokarst.Phyla)), decreasing=TRUE)[1:howManyPhyla])
ps.justPalsa_topPhyla <- prune_taxa(topPhyla_palsa, ps.justPalsa.Phyla)
ps.justThermokarst_topPhyla <- prune_taxa(topPhyla_Thermokarst, ps.justThermokarst.Phyla)

phylumTop.Pal <- plot_bar(ps.justPalsa_topPhyla, x="DepthSection", fill = "Phylum", facet_grid=~Core ) +
                          geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack") +
                          theme(axis.text=element_text(size=12),
                                legend.text=element_text(size=20)) +
                          labs(title='Palsa') + theme(plot.title = element_text(hjust = 0.5))
phylumTop.tk  <- plot_bar(ps.justThermokarst_topPhyla, x="DepthSection", fill = "Phylum", facet_grid=~Core ) +
                                geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack") +
                                theme(axis.text=element_text(size=12)) +
                                theme( axis.text.y=element_blank(),
                                       axis.ticks.y=element_blank(),
                                       legend.text=element_text(size=20) ) +
                                ylab(NULL) +
                                labs(title='Thermokarst') + theme(plot.title = element_text(hjust = 0.5))
phylumTop.Pal + phylumTop.tk ## Thermodesulfobacteriota pops up in the thermokarst systems
## I guess these would be potential symbiotes for the ANME bacteria if they are in there.   


## good review/reminder, for oxygen levels etc.
https://books.gw-project.org/groundwater-microbiology/chapter/redox-conditions/


## let's check the archeal diversity of each of these:

ps.Archaea <- subset_taxa(ps007_cleaned_sqrt_prop, Kingdom == "Archaea")
psObject <- ps.Archaea
howManyPhyla <- 10
ps.justPalsa <- subset_samples(psObject, Subsite=="Palsa")
ps.justPalsa.Phyla <- tax_glom(ps.justPalsa, taxrank="Phylum")
ps.justThermokarst <- subset_samples(psObject, Subsite=="Thermokarst")
ps.justThermokarst.Phyla <- tax_glom(ps.justThermokarst, taxrank="Phylum")
topPhyla_palsa <- names(sort(colSums(otu_table(ps.justPalsa.Phyla)), decreasing=TRUE)[1:howManyPhyla])
topPhyla_Thermokarst <- names(sort(colSums(otu_table(ps.justThermokarst.Phyla)), decreasing=TRUE)[1:howManyPhyla])
ps.justPalsa_topPhyla <- prune_taxa(topPhyla_palsa, ps.justPalsa.Phyla)
ps.justThermokarst_topPhyla <- prune_taxa(topPhyla_Thermokarst, ps.justThermokarst.Phyla)
phylumTop.Pal <- plot_bar(ps.justPalsa_topPhyla, x="DepthSection", fill = "Phylum", facet_grid=~Core ) +
                          geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack") +
                          theme(axis.text=element_text(size=12),
                                legend.text=element_text(size=20)) +
                          labs(title='Palsa Archea') + theme(plot.title = element_text(hjust = 0.5))
phylumTop.tk  <- plot_bar(ps.justThermokarst_topPhyla, x="DepthSection", fill = "Phylum", facet_grid=~Core ) +
                                geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack") +
                                theme(axis.text=element_text(size=12)) +
                                theme( axis.text.y=element_blank(),
                                       axis.ticks.y=element_blank(),
                                       legend.text=element_text(size=20) ) +
                                ylab(NULL) +
                                labs(title='Thermokarst Archea') + theme(plot.title = element_text(hjust = 0.5))
phylumTop.Pal + phylumTop.tk ## lots of halobacteria, not that useful because of the confusing state of archaeal taxonomy

## break this down by order:

ps.Archaea <- subset_taxa(ps007_cleaned_sqrt_prop, Kingdom == "Archaea")
psObject <- ps.Archaea
howManyOTUs <- 10
ps.justPalsa <- subset_samples(psObject, Subsite=="Palsa")
ps.justPalsa.Order <- tax_glom(ps.justPalsa, taxrank="Order")
ps.justThermokarst <- subset_samples(psObject, Subsite=="Thermokarst")
ps.justThermokarst.Order <- tax_glom(ps.justThermokarst, taxrank="Order")
topOrder_palsa <- names(sort(colSums(otu_table(ps.justPalsa.Order)), decreasing=TRUE)[1:howManyOTUs])
topOrder_Thermokarst <- names(sort(colSums(otu_table(ps.justThermokarst.Order)), decreasing=TRUE)[1:howManyOTUs])
ps.justPalsa_topOrder <- prune_taxa(topOrder_palsa, ps.justPalsa.Order)
ps.justThermokarst_topOrder <- prune_taxa(topOrder_Thermokarst, ps.justThermokarst.Order)
orderTop.Pal <- plot_bar(ps.justPalsa_topOrder, x="DepthSection", fill = "Order", facet_grid=~Core ) +
                          geom_bar(aes(color=Order, fill=Order), stat="identity", position="stack") +
                          theme(axis.text=element_text(size=12),
                                legend.text=element_text(size=20)) +
                          labs(title='Palsa Archea') + theme(plot.title = element_text(hjust = 0.5))
orderTop.tk  <- plot_bar(ps.justThermokarst_topOrder, x="DepthSection", fill = "Order", facet_grid=~Core ) +
                                geom_bar(aes(color=Order, fill=Order), stat="identity", position="stack") +
                                theme(axis.text=element_text(size=12)) +
                                theme( #axis.text.y=element_blank(),
                                       #axis.ticks.y=element_blank(),
                                       legend.text=element_text(size=20) ) +
                                ylab(NULL) +
                                labs(title='Thermokarst Archea') + theme(plot.title = element_text(hjust = 0.5))
orderTop.Pal + orderTop.tk 







## where would Methanomicrobiales be? in the Halobacteriales, methinks:

ps.Archaea

aa <- subset_taxa(ps.Archaea, Order=="Methanomicrobiales")
tax_table(aa)
## halobacteria has Methanomicrobiales, the largest group of methanogens

## plot the relative abundance of this group?:
## 
aa <- subset_taxa(ps.Archaea, Order=="Methanomicrobiales")
tax_table(aa)
ps.Methanomicrobiales <- subset_taxa(ps007_cleaned_sqrt_prop, Order=="Methanomicrobiales")
psObject <- ps.Methanomicrobiales
tLevel <- "Order"
howManyOTUs <- 10
## and if we allow the top phyla to vary between pal and tk sites?
ps.justPalsa <- subset_samples(psObject, Subsite=="Palsa")
ps.justPalsa.OTUs <- tax_glom(ps.justPalsa, taxrank=tLevel)
ps.justThermokarst <- subset_samples(psObject, Subsite=="Thermokarst")
ps.justThermokarst.OTUs <- tax_glom(ps.justThermokarst, taxrank=tLevel)
topPhyla_palsa <- names(sort(colSums(otu_table(ps.justPalsa.OTUs)), decreasing=TRUE)[1:howManyOTUs])
topPhyla_Thermokarst <- names(sort(colSums(otu_table(ps.justThermokarst.OTUs)), decreasing=TRUE)[1:howManyOTUs])
ps.justPalsa_topOTUs <- prune_taxa(topPhyla_palsa, ps.justPalsa.OTUs)
ps.justThermokarst_topOTUs <- prune_taxa(topPhyla_Thermokarst, ps.justThermokarst.OTUs)
phylumTop.Pal <- plot_bar(ps.justPalsa_topOTUs, x="DepthSection", fill = tLevel, facet_grid=~Core ) +
                          geom_bar(aes(color=Order, fill=Order), stat="identity", position="stack") +
                          theme(axis.text=element_text(size=12),
                                legend.text=element_text(size=20)) +
                          labs(title='Palsa Archea') + theme(plot.title = element_text(hjust = 0.5))
phylumTop.tk  <- plot_bar(ps.justThermokarst_topOTUs, x="DepthSection", fill = tLevel, facet_grid=~Core ) +
                                geom_bar(aes(color=Order, fill=Order), stat="identity", position="stack") +
                                theme(axis.text=element_text(size=12)) +
                                theme( #axis.text.y=element_blank(),
                                       #axis.ticks.y=element_blank(),
                                       legend.text=element_text(size=20) ) +
                                ylab(NULL) +
                                labs(title='Thermokarst Archea') + theme(plot.title = element_text(hjust = 0.5))

phylumTop.Pal + phylumTop.tk ## The methanogens are pretty important here, especially in the thermokarst system


##### finding ANME groups #####

## we need to track down the ANME groups.

## plan - run an alignment of our 16s reads, into the silva phylogeny
## highlight ANME known ANME sequences 
## can find them with the SILVA online search tool ("taxonomy == ANME")

## which computer would be most appropriate here? try it with the optiplex:

## manual for sina: https://www.arb-silva.de/fileadmin/silva_databases/SINA/1.2.8/sina-manual.pdf

## following: https://sina.readthedocs.io/en/latest/commandline.html

conda create -n sina sina

conda activate  sina

## the reference has to be in arb format. Surely we already 
## have the arb silva db somewhere?

## maybe not. how can we get it? 
## probably: https://www.arb-silva.de/arb-files

#arbSilvaDB=/home/daniel/Documents/databases/silva/silva.arb.gz ## laptop?
arbSilvaDB=/media/vol/phylo_dbs/silva/arb/silva.arb.gz ## desktop 
wget https://www.arb-silva.de/fileadmin/silva_databases/release_138_2/ARB_files/SILVA_138.2_SSURef_NR99_03_07_24_opt.arb.gz \
  -O $arbSilvaDB

## our unaligned references would be our reference sequences from our phyloseq 
## object:

R
library("phyloseq")
library("Biostrings")
load("ps007_cleaned_sqrt_prop.rda")
rs <- refseq(ps007_cleaned_sqrt_prop)
writeXStringSet(rs,"ps007_cleaned_sqrt_prop_RefSeqs.fa", format="fasta")

## or focus this to just archaea, since we are just trying to find 
## the ANME sequences:

ps.archaea <- subset_taxa(ps007_cleaned_sqrt_prop, Kingdom=="Archaea")
rs <- refseq(ps.archaea)
writeXStringSet(rs,"ps007_cleaned_sqrt_prop_ArchaeaRefSeqs.fa", format="fasta")

## on laptop:
#cd /home/daniel/Documents/projects/wernerSphagnum/sphagnumCUEmetabarcoding/sequenceAnalysis/findANME
## database on laptop:
#/home/daniel/Documents/databases/silva/SILVA_138.2_SSURef_NR99_03_07_24_opt.arb

## following the tutorials from arb, #2 and #3 of ARB Workshop at C-MORE (2009)
## get them here: https://hahana.soest.hawaii.edu/cmoreserver/education/grads-postdocs/arb_workshop.htm

## do the alignments, on optiplex:

arbSilvaDB=/home/daniel/Documents/databases/silva/silva.arb
outFolder=/home/daniel/Documents/projects/wernerSphagnum/sphagnumCUEmetabarcoding/sequenceAnalysis/findANME/

cd /home/daniel/Documents/projects/wernerSphagnum/sphagnumCUEmetabarcoding/sequenceAnalysis

conda activate sina

sina  -i ps007_cleaned_sqrt_prop_ArchaeaRefSeqs.fa -r $arbSilvaDB -o $outFolder/refArchSeqsInSilva.afa

## and back on desktop, do the merge in ARB again.

## save the merged archive here:

cd /media/vol/wernerSphagnumBackups/arb/

## and again, adding it in arb, does not look good. 
## as far as I can see, it disagrees totally with our
## rdb/silva taxonomic assignments. Says there 
## are just two tight clades of archea, in Nitrosphaera
## sortof, and all rest off by themselves, in Thermoplasmata. 
## something didn't work. 



## maybe we should have checked the direction of the reads?


## on optiplex, just check on set of reads:
silvaDB=/home/daniel/Documents/databases/silva/silva_nr99_v138.2_toGenus_trainset.fa
reads=/home/daniel/Documents/projects/wernerSphagnum/wernerSphagnumSequences/
vsearch \
   --orient ${reads}Oemik-002011_S38_L001_R1_001.fastq.gz \
   --db $silvaDB \
   --fastaout  oriented.fa \
   --notmatched ogHylo_strongNostocMatches_NotOriented.fa

## nope, that is not the issue, all are correctly oriented. 

## maybe get silva archeael tree only, and
## associated sequences. Then do a denovo alignment with SSU-Align?

## mark the archaea group
## File --> Export --> export to external format --> compress all gaps, fasta_wacc.eft, 
## stored it here:

less /media/vol/wernerSphagnumBackups/arb/silvaOnlyArchea.fasta

## lots of weird white space. Get rid of it, go to DNA
seqtk seq -S -l 0 silvaOnlyArchea.fasta |
sed '/^[^>]/ y/uU/tT/' |
sed '/>/ s/rna//g' > archea.fa 

## but accession information not retained here. why not?
## it looks like it ANME are best identified using the tax_slv 
## field with "*ANME*"
## but this is still only ~400 sequences. Either the 
## ARB database is out of sync (behind) with the normal silva 
## database. There are ~6000 sequences with "ANME" in the
## taxonomy field on the online silva db. 

## try combining:
## 1. all the ANME sequences from silva
## 2. archea from the ARB database
## 3. our archeal sequences    

## then find all of our ASVs and see if they are near the ANME 
## sequences?

## alternatively, take our archeal sequences from SILVA? this is 
## 347,000 sequences, of course way too large. 

## or, download the archaea sequences with gaps, and use silva to 
## add ours again using sina. Try this first. This should essentially
## be an MSA for all of archaea.

## requested arb db of all archea sequences from silva online db

conda activate sina

myRefSeqs=/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/ps007_cleaned_sqrt_prop_ArchaeaRefSeqs.fa
outFolder=/media/vol/wernerSphagnumBackups/arb
archaeaArb=/media/vol/phylo_dbs/silva/arb/arb-silva.de_2026-02-19_id1467113_trunc.arb 
sina  -i $myRefSeqs -r $archaeaArb -o $outFolder/refArchSeqsInArchaeaSilva.afa

cd /media/vol/wernerSphagnumBackups/arb

## import in arb, then export it and all the other sequences from the Archaea-only arb DB
## as an alignment, 

less /media/vol/wernerSphagnumBackups/arb/refArchSeqsInArchaeaSilva.afa

## not working, can't seem to find a way to export it that keeps all the data
## we need. 


##### 
## can we recreate this with the laptop? We need:

## arb directory of all archea from silva
## on office comp:
/media/vol/phylo_dbs/silva/arb/arb-silva.de_2026-02-19_id1467113_trunc.arb
/media/vol/phylo_dbs/silva/arb/arb-silva.de_2026-02-19_id1467113_trunc.sidx

## our archeal reads aligned to this using Silva.
## on office comp:
/media/vol/wernerSphagnumBackups/arb/refArchSeqsInArchaeaSilva.afa
## to get these:

#getFile=/media/vol/phylo_dbs/silva/arb/arb-silva.de_2026-02-19_id1467113_trunc.*
getFile=/media/vol/wernerSphagnumBackups/arb/refArchSeqsInArchaeaSilva.afa
putDir=/home/daniel/Documents/projects/wernerSphagnum/arb/
rsync -auv --progress daniel@132.180.112.24:$getFile $putDir

## so on the laptop, use the following dir:
cd /home/daniel/Documents/projects/wernerSphagnum/arb

######

## we can export all these with ARB, but I cannot seem to retain the really important 
## info about whether or not a species is an ANME archaea.

## for the moment, export the alignment, and also a list of names of ANME archea

## the ANME archaea accession names are here, on officeComp

less /home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/findANME/silvaANMEarchaea.csv

## AB239077...no mention of ANME in the NCBI accession. But somehow, silva is calling it a ANME archaea.
## wonder how they decide...

## 
## the full alignment of our archaeal reads withina all the silva Archaea is here, on officeComp
ls /media/vol/wernerSphagnumBackups/arb/silvaArchea_ourArchea.afa 

## lots of weird white space. Get rid of it, go to DNA
seqtk seq -S -l 0 silvaArchea_ourArchea.afa |
sed '/^[^>]/ y/uU/tT/' |
sed '/>/ s/rna//g' > silvaArchea_ourArchea_cleaned.afa 

## didn't really work. let's see if we can do without a cleaning step.

## this is probably too large to make a tree on our desktop? Try it: 
alignOut=/media/vol/wernerSphagnumBackups/arb/silvaArchea_ourArchea.afa 
FastTree -gtr -nt < $alignOut > refArchaeaSilvaArchaea.nwk

## anyway, the real next step is try to change the labels for these to note whether they
## are ANME, otherwise we have to change them on the tree anyway

## yup, too big. And can't load it into memory on my desktop on python script below
## so put this file onto the optiplex.

## nope optiplex is updating firmware. put on the nanoComp
cd /media/vol/wernerSphagnumBackups/arb/

pigz silvaArchea_ourArchea.afa

getFile=/media/vol/wernerSphagnumBackups/arb/silvaArchea_ourArchea.afa.gz
#getFile=/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/findANME/silvaANMEarchaea.csv
putDir=/media/vol1/daniel/wernerPeat/looking4ANME/
rsync -auv --progress $getFile test@132.180.112.115:$putDir

##
## on nanocomp:

cd /media/vol1/daniel/wernerPeat/looking4ANME/

pigz silvaArchea_ourArchea.afa
unpigz silvaArchea_ourArchea.afa.gz

pigz silvaArchea_ourArchea_relabeled.afa
unpigz silvaArchea_ourArchea_relabeled.afa.gz

## let's make a toy file to develop the code:

head -n40000 silvaArchea_ourArchea.afa > toy.afa ## then trim off last sequence with vim
tail -n40000 silvaArchea_ourArchea.afa > toy2.afa ## trim off top and bottom with vim
cat toy.afa toy2.afa > toy3.afa

python3
import os, re
import Bio.Seq
import Bio.SeqRecord 
import Bio.AlignIO 
import pandas as pd

#alignment = Bio.AlignIO.read("toy3.afa", "fasta")

alignment = Bio.AlignIO.read("silvaArchea_ourArchea.afa", "fasta")

for record in alignment:
    print(record.description)

## we want to:
## 1. replace the record.id with this last part of our string from 
## the Description, which is the accession number
## 2. denote if it is an ANME archaea 


ANMEaccessions = (pd.read_csv("silvaANMEarchaea.csv", header=None)[[0,1]]
                   .rename({0:"Accession",1:"Notes"}, axis=1))

a=0
for record in alignment:
    accession = re.split(r'\s', record.description)[-1]
    silvaNum = re.split(r'\s', record.description)[0]
    record.name = accession + "-" + silvaNum
    record.id  = record.name
    record.description  = ""
    if accession in ANMEaccessions['Accession'].to_list():
      a += 1
      record.description  = "ANME"
      record.name = accession + "-" + silvaNum + "-" + "ANME"

for record in alignment:
    print(record)

a == ANMEaccessions.shape[0] ## yup, all ANME accessions maintained.

for record in alignment:
    if "ANME" in record.description:
      print(record)

## looks right.

Bio.AlignIO.write(alignment, "silvaArchea_ourArchea_relabeled.afa", "fasta")

## coming back to this, fasttree is reporting duplicate names:

names = []
for record in alignment:
      names.append(record.name)

names = pd.Series(names)

sum(names.duplicated(keep=False)) ## whoah, 392 duplicated accession names.

dupFilt = names.duplicated(keep=False)

names[dupFilt].to_list()

## yeah, these come from genomes with different 16s, I think.
## renamed above to be unique, try again.


sudo wget https://morgannprice.github.io/fasttree/FastTreeMP -O /usr/local/bin/FastTreeMP
#sudo chmod 555 /usr/local/bin/FastTreeMP

## make the tree
cd /home/daniel/Documents/projects/wernerSphagnum/looking4ANME ## on optiplex

nohup bash -c 'FastTreeMP -gtr -nt < silvaArchea_ourArchea_relabeled.afa > refArchaeaSilvaArchaea.nwk' &

## dies on both, try without multithreading:

nohup bash -c 'FastTree -gtr -nt < silvaArchea_ourArchea_relabeled.afa > refArchaeaSilvaArchaea.nwk' &
## started on opti at 12:53, Thurs

## nanoComp can't handle it, at least the multithreaded version.
## optiplex can't handle it, either.

## try the single thread version. It can run  

## move it to the optiplex:

## oops, no keys ##
ssh-copy-id -i /home/test/.ssh/nano2opti.pub daniel@132.180.113.114
ssh-keygen -p 
ssh-copy-id -p 30272 -i ${path2key}/funmicStudent05.pub ubuntu@129.70.51.6
ssh -i /home/test/.ssh/nano2opti daniel@132.180.113.114
####################

getFile=/media/vol1/daniel/wernerPeat/looking4ANME/silvaArchea_ourArchea_relabeled.afa.gz
putDir=/home/daniel/Documents/projects/wernerSphagnum/looking4ANME/
rsync -auv $getFile daniel@132.180.113.114:$putDir

## yup. Even the single threaded version overloads even the optiplex


{ \time -v ls > ls.log ; } 2> time.log

nohup \time -v bash -c 'ls -lth'

nohup { \time -v bash -c 'FastTree -gtr -nt < silvaArchea_ourArchea_relabeled.afa > refArchaeaSilvaArchaea.nwk' } 2> time.log


## nope, none of this works. The archaeal section of Silva is just too
## large, can't rebuild the tree with just our local computing 
## resources. 

## revisit the existing arb database of silva. 
## Re-download, first try local on desktop

/media/vol/phylo_dbs/silva/arb/SILVA_138.2_SSURef_NR99_03_07_24_opt.arb

## can we extract just the archea?:
 
## yes, but don't forget to keep a bacteria for rooting..

## so kept Nostoc punctiforme sequence as an outgroup, plus the whole archaeal
## clade.

## use sina, try again to integrate our archaea into this:

conda activate sina

myRefSeqs=/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/ps007_cleaned_sqrt_prop_ArchaeaRefSeqs.fa
outFolder=/media/vol/wernerSphagnumBackups/arb
archaeaArb=/media/vol/phylo_dbs/silva/arb/SILVA_138.2_SSURef_NR99_Archeae.arb
sina  -i $myRefSeqs -r $archaeaArb -o $outFolder/refArchSeqsInArchaeaSilva.afa

## try adding this to our alignment and tree in ARB
/media/vol/wernerSphagnumBackups/arb/refArchSeqsInArchaeaSilva.afa

## and again, it lumps all our sequences into monophyletic two clades, one near thermococcus and one 
## one in Caldarchaeales/Nitrosphaeria. This doesn't make sense, really. 
## this doesn't match our silva classifications using RDP classifier
## which are generally much more sensible, ecologically. 

## so, let's try again with this smaller database to make our own tree. 
## we don't know where the error lies - is it in the combined alignment
## from silva, or in the parsimony tree building?

## so work backward - first export the combined sina alignment and see
## using fasttree fixes our issue.
## second (if #1 doesn't work) try an alignment with the smaller 
## archaeal sequence database with SSU-align, then rebuild tree. 

mv ourArchaea_SilvaArchaea_combo.fasta ourArchaea_SilvaArchaea_combo.afa
#pigz ourArchaea_SilvaArchaea_combo.afa

## number 1 - export combo alignment, (cleanup?), and try making a tree:
getFile=/media/vol/wernerSphagnumBackups/arb/ourArchaea_SilvaArchaea_combo.afa
putDir=/home/daniel/Documents/projects/wernerSphagnum/sphagnumCUEmetabarcoding/sequenceAnalysis/findANME
rsync -auvz $getFile daniel@132.180.113.114:$putDir

## on optiplex

cd /home/daniel/Documents/projects/wernerSphagnum/sphagnumCUEmetabarcoding/sequenceAnalysis/findANME

nohup bash -c 'FastTreeMP -gtr -nt < ourArchaea_SilvaArchaea_combo.afa > refArchaeaSilvaArchaea.nwk' &

## and done. Check the results:

getFile=/home/daniel/Documents/projects/wernerSphagnum/sphagnumCUEmetabarcoding/sequenceAnalysis/findANME/refArchaeaSilvaArchaea.nwk
putDir=/media/vol/wernerSphagnumBackups/arb/
rsync -auvz daniel@132.180.113.114:$getFile $putDir

arb refArchSeqsInArchaeaSilva.afa refArchaeaSilvaArchaea.nwk 

## actually looks like it worked. But the information about which of these 
## are ANME is lost...

## so, change names to be unique, but with both NCBI accession and if it is 
## a known ANME:

cd /media/vol/wernerSphagnumBackups/arb

python3
import os, re
import Bio.Seq
import Bio.SeqRecord 
import Bio.AlignIO 
import pandas as pd

#alignment = Bio.AlignIO.read("toy3.afa", "fasta")
alignment = Bio.AlignIO.read("ourArchaea_SilvaArchaea_combo.afa", "fasta")

for record in alignment:
    print(record)

ANMEaccessions = (pd.read_csv("/media/vol/wernerSphagnumBackups/arb/ANME.csv", header=None)
                   .rename({0:"silva",1:"notes",2:"accession"}, axis=1))


ANMEaccessions['accession']

a=0
b=[]
for record in alignment:
    accession = re.split(r'\s', record.description)[-1]
    silvaNum = re.split(r'\s', record.description)[0]
    record.name = accession + "-" + silvaNum
    record.id = record.name
    record.description  = ""
    if accession in ANMEaccessions['accession'].to_list():
      a += 1
      record.description  = "ANME"
      record.name = record.name + "-" + "ANME"




a == ANMEaccessions.shape[0] ## yup, all ANME accessions maintained.

for record in alignment:
    if "ANME" in record.description:
      print(record)

## looks right. Try this. We will lose all taxonomic information but 
## we hopefully recover the ANME clades. We'll see. 

Bio.AlignIO.write(alignment, "ourArchaea_SilvaArchaea_combo_relabeled.afa", "fasta")

## repeating above, rerun the tree with this relabeled alignment.

getFile=/media/vol/wernerSphagnumBackups/arb/ourArchaea_SilvaArchaea_combo_relabeled.afa
putDir=/home/daniel/Documents/projects/wernerSphagnum/sphagnumCUEmetabarcoding/sequenceAnalysis/findANME
rsync -auvz $getFile daniel@132.180.113.114:$putDir

## rerun nohup fasttree command above on optiplex:

cd /home/daniel/Documents/projects/wernerSphagnum/sphagnumCUEmetabarcoding/sequenceAnalysis/findANME

nohup bash -c 'FastTreeMP -gtr -nt < ourArchaea_SilvaArchaea_combo_relabeled.afa > refArchaeaSilvaArchaea.nwk' &

## stopping here on 27.2.26. 
## If the world doesn't end in the meantime, 
## when I come back, make an arb database with the new tree.

## should be the following:
## get newick from opti:

getFile=/home/daniel/Documents/projects/wernerSphagnum/sphagnumCUEmetabarcoding/sequenceAnalysis/findANME/refArchaeaSilvaArchaea.nwk
putDir=/media/vol/wernerSphagnumBackups/arb/
rsync -auvz daniel@132.180.113.114:$getFile $putDir

## start an arb database using this file and:

ourArchaea_SilvaArchaea_combo_relabeled.afa

## see if the ANME clades are recovered, and if we have any 
## sequences in them. 

## if not, double check results by manually looking for rdb tax assignments
## that are within the clades on the archeal ARB database for ANME (they are
## pretty clear). 



###########

## since that will probably fail...how would we set up a new alignment for #2? 
## Export that unaligned file from arb. Clean up first with biopython?

## first, get both lists of unaligned sequences:

## 16S archeal reads are:
/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/ps007_cleaned_sqrt_prop_ArchaeaRefSeqs.fa

## export the archaeal reads, unaligned, and the nostoc:
ls /home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/findANME/ArchaeaSilvaUnaligned.fasta

## clean up the white space:

cd /home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/findANME

#seqtk seq -S ArchaeaSilvaUnaligned.fasta > ArchaeaSilvaUnaligned_cleaned.fasta
#mv ArchaeaSilvaUnaligned_cleaned.fasta ArchaeaSilvaUnaligned.fasta
seqtk seq -S ../ps007_cleaned_sqrt_prop_ArchaeaRefSeqs.fa > ps007_cleaned_sqrt_prop_ArchaeaRefSeqs_cleaned.fa

## concatenate them and 
cat ArchaeaSilvaUnaligned.fasta ps007_cleaned_sqrt_prop_ArchaeaRefSeqs_cleaned.fa >\
archaeaSilva_ourArchaea_combo_unaligned.fa

## put on the nanoComp, since we are using the optiplex
getFile=/home/daniel/Documents/projects/wernerSphagnum/sequenceAnalysis/findANME/archaeaSilva_ourArchaea_combo_unaligned.fa
putDir=test@132.180.112.115:/media/vol1/daniel/wernerPeat/looking4ANME/
rsync -auv $getFile $putDir

## run ssu-align on these on nanoComp:

conda activate ssu-align

cd /media/vol1/daniel/wernerPeat/looking4ANME/

## not run ## 

ssu-align -n bacteria $seqs2align nostocaceaeCyanoseqPlusOurSeqs_ali

ssu-align -n bacteria $seqs2align nostocaceaeCyanoseqPlusOurSeqs_ali
ssu-mask --pf 0.9999 --pt 0.9999 nostocaceaeCyanoseqPlusOurSeqs_ali
ssu-mask --stk2afa nostocaceaeCyanoseqPlusOurSeqs_ali

